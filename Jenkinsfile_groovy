node{

    properties([
    buildDiscarder(
        logRotator(
            numToKeepStr: '20'
            )),
    ])

    //def counter = 0
    //def data = "Version" + counter
    //writeFile(file: 'version.txt', text: counter.toString())

    stage"========^^^^^^ Clone sources ^^^^^^========"
    git url: 'https://github.com/HamzaABDOULI/spring-boot-angular-11-mysql.git'

    stage ('Build and Package' ) {
        dir('spring-boot-server'){
            if (fileExists('C:/ProgramData/Jenkins/.jenkins/workspace/Angular-SpringBoot-Groovy/version.txt')) {
                    def readcounter =    readFile(file: 'version.txt')
                    readcounter = readcounter.toInteger() +1
                    def version= "Version" + readcounter
                    println(version)
                    bat 'mvn package -Dartifactversion=' + "${version}"
                    writeFile(file: 'version.txt', text:readcounter.toString())
                } 
            else {
                    currentBuild.result = "FAILURE" 
                } 
                    echo "Build and Package Completed" 
            }
    }
       
        
    stage"Build SpringBoot Project"
    echo "========^^^^^^ Start Building the SpringBoot project ^^^^^^========"
    dir('spring-boot-server'){
        bat "mvn install clean" 
    }

    stage"BuildAngular Project"
    echo "========^^^^^^ Start Building the Angular project ^^^^^^========"
    dir('angular-11-client'){
        bat 'npm install'
        bat 'npm run ng -- build'
        bat 'tar.exe cf dist.zip dist' 
    }

    stage "Archive build output"
    archiveArtifacts artifacts: '**/*.jar, **/angular-11-client/dist.zip', onlyIfSuccessful: true
}